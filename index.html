<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Invoice Data Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .upload-section {
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-input-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-block;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .file-name {
            margin-top: 15px;
            color: #666;
            font-size: 1em;
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            padding: 40px;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 2000px;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.85em;
            white-space: nowrap;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .download-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(17, 153, 142, 0.4);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .error {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .error.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Excel Invoice Data Analyzer</h1>
            <p>Upload your Excel file to extract and analyze invoice data</p>
        </div>

        <div class="upload-section">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                <label for="fileInput" class="file-input-label">
                    üìÅ Choose Excel File
                </label>
            </div>
            <div class="file-name" id="fileName">No file chosen</div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #666;">Analyzing your Excel file...</p>
            </div>

            <div class="error" id="error"></div>
        </div>

        <div class="results-section" id="results">
            <div class="stats" id="stats"></div>

            <button class="download-btn" onclick="downloadExcel()">
                üíæ Download as Excel
            </button>

            <button class="download-btn" onclick="downloadCSV()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin-left: 10px;">
                üìÑ Download as CSV
            </button>

            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Months</th>
                            <th>GSTIN of customer</th>
                            <th>Customer Name</th>
                            <th>Invoice number</th>
                            <th>Invoice date</th>
                            <th>Due Date</th>
                            <th>HSN/SAC</th>
                            <th>Description</th>
                            <th>Invoice Value (Rs)</th>
                            <th>Place of supply</th>
                            <th>Taxable Value (Rs)</th>
                            <th>Integrated Tax (Rs)</th>
                            <th>Central Tax (Rs)</th>
                            <th>State/UT Tax (Rs)</th>
                            <th>Cess (Rs)</th>
                            <th>Sub Total</th>
                            <th>TDS</th>
                            <th>Discount</th>
                            <th>Total</th>
                            <th>Receiving status</th>
                            <th>Amount due</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let processedData = [];

        const headerMappings = {
            'months': ['month', 'months', 'period', 'billing month'],
            'gstin': ['gstin', 'gst', 'gstin of customer', 'customer gstin', 'gst number', 'gstin number'],
            'customer_name': ['customer name', 'customer', 'party name', 'client name', 'buyer name', 'name'],
            'invoice_number': ['invoice number', 'invoice no', 'inv no', 'bill no', 'invoice', 'bill number'],
            'invoice_date': ['invoice date', 'date', 'inv date', 'bill date', 'invoice dt'],
            'due_date': ['due date', 'payment due date', 'due dt', 'payment date'],
            'hsn_sac': ['hsn', 'sac', 'hsn/sac', 'hsn code', 'sac code', 'hsn sac'],
            'description': ['description', 'desc', 'particulars', 'item description', 'product description', 'details'],
            'invoice_value': ['invoice value', 'total value', 'total amount', 'invoice amount', 'gross amount'],
            'place_of_supply': ['place of supply', 'supply place', 'location', 'state', 'place'],
            'taxable_value': ['taxable value', 'taxable amount', 'base amount', 'assessable value'],
            'integrated_tax': ['integrated tax', 'igst', 'igst amount', 'integrated gst'],
            'central_tax': ['central tax', 'cgst', 'cgst amount', 'central gst'],
            'state_tax': ['state tax', 'sgst', 'utgst', 'sgst amount', 'state gst', 'state/ut tax'],
            'cess': ['cess', 'cess amount', 'cess value'],
            'sub_total': ['sub total', 'subtotal', 'sub-total', 'amount before tax'],
            'tds': ['tds', 'tds amount', 'tax deducted at source'],
            'discount': ['discount', 'disc', 'discount amount'],
            'total': ['total', 'net amount', 'final amount', 'grand total'],
            'receiving_status': ['receiving status', 'status', 'payment status', 'receipt status'],
            'amount_due': ['amount due', 'due amount', 'pending amount', 'outstanding']
        };

        document.getElementById('fileInput').addEventListener('change', handleFile);

        async function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('loading').classList.add('active');
            document.getElementById('error').classList.remove('active');
            document.getElementById('results').classList.remove('active');

            try {
                const data = await readExcelFile(file);
                processData(data);
                displayResults();
                document.getElementById('loading').classList.remove('active');
                document.getElementById('results').classList.add('active');
            } catch (error) {
                document.getElementById('loading').classList.remove('active');
                showError('Error processing file: ' + error.message);
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });

                        let allData = [];
                        workbook.SheetNames.forEach(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                                raw: false,
                                dateNF: 'dd/mm/yyyy',
                                defval: ''
                            });
                            allData = allData.concat(jsonData);
                        });

                        resolve(allData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }

        function normalizeHeader(header) {
            return header.toLowerCase().trim().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' ');
        }

        function findMatchingKey(headers, mappingKey) {
            const possibleHeaders = headerMappings[mappingKey];
            for (let header of headers) {
                const normalized = normalizeHeader(header);
                for (let possible of possibleHeaders) {
                    if (normalized.includes(possible) || possible.includes(normalized)) {
                        return header;
                    }
                }
            }
            return null;
        }

        function parseDate(dateValue) {
            if (!dateValue) return 'N/A';

            if (dateValue instanceof Date) {
                const day = String(dateValue.getDate()).padStart(2, '0');
                const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                const year = dateValue.getFullYear();
                return `${day}/${month}/${year}`;
            }

            if (typeof dateValue === 'string') {
                dateValue = dateValue.trim();
                if (dateValue.match(/^\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}$/)) {
                    return dateValue;
                }
            }

            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + dateValue * 86400000);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            return dateValue;
        }

        function parseNumber(value) {
            if (value === null || value === undefined || value === '') return 'N/A';

            if (typeof value === 'number') return value.toFixed(2);

            if (typeof value === 'string') {
                const cleaned = value.replace(/[^\d.-]/g, '');
                const num = parseFloat(cleaned);
                return isNaN(num) ? 'N/A' : num.toFixed(2);
            }

            return 'N/A';
        }

        function processData(rawData) {
            if (!rawData || rawData.length === 0) {
                throw new Error('No data found in Excel file');
            }

            const headers = Object.keys(rawData[0]);

            const columnMap = {
                months: findMatchingKey(headers, 'months'),
                gstin: findMatchingKey(headers, 'gstin'),
                customer_name: findMatchingKey(headers, 'customer_name'),
                invoice_number: findMatchingKey(headers, 'invoice_number'),
                invoice_date: findMatchingKey(headers, 'invoice_date'),
                due_date: findMatchingKey(headers, 'due_date'),
                hsn_sac: findMatchingKey(headers, 'hsn_sac'),
                description: findMatchingKey(headers, 'description'),
                invoice_value: findMatchingKey(headers, 'invoice_value'),
                place_of_supply: findMatchingKey(headers, 'place_of_supply'),
                taxable_value: findMatchingKey(headers, 'taxable_value'),
                integrated_tax: findMatchingKey(headers, 'integrated_tax'),
                central_tax: findMatchingKey(headers, 'central_tax'),
                state_tax: findMatchingKey(headers, 'state_tax'),
                cess: findMatchingKey(headers, 'cess'),
                sub_total: findMatchingKey(headers, 'sub_total'),
                tds: findMatchingKey(headers, 'tds'),
                discount: findMatchingKey(headers, 'discount'),
                total: findMatchingKey(headers, 'total'),
                receiving_status: findMatchingKey(headers, 'receiving_status'),
                amount_due: findMatchingKey(headers, 'amount_due')
            };

            processedData = rawData.map(row => {
                return {
                    months: row[columnMap.months] || 'N/A',
                    gstin: row[columnMap.gstin] || 'N/A',
                    customer_name: row[columnMap.customer_name] || 'N/A',
                    invoice_number: row[columnMap.invoice_number] || 'N/A',
                    invoice_date: parseDate(row[columnMap.invoice_date]),
                    due_date: parseDate(row[columnMap.due_date]),
                    hsn_sac: row[columnMap.hsn_sac] || 'N/A',
                    description: row[columnMap.description] || 'N/A',
                    invoice_value: parseNumber(row[columnMap.invoice_value]),
                    place_of_supply: row[columnMap.place_of_supply] || 'N/A',
                    taxable_value: parseNumber(row[columnMap.taxable_value]),
                    integrated_tax: parseNumber(row[columnMap.integrated_tax]),
                    central_tax: parseNumber(row[columnMap.central_tax]),
                    state_tax: parseNumber(row[columnMap.state_tax]),
                    cess: parseNumber(row[columnMap.cess]),
                    sub_total: parseNumber(row[columnMap.sub_total]),
                    tds: parseNumber(row[columnMap.tds]),
                    discount: parseNumber(row[columnMap.discount]),
                    total: parseNumber(row[columnMap.total]),
                    receiving_status: row[columnMap.receiving_status] || 'N/A',
                    amount_due: parseNumber(row[columnMap.amount_due])
                };
            });
        }

        function displayResults() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            processedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.months}</td>
                    <td>${row.gstin}</td>
                    <td>${row.customer_name}</td>
                    <td>${row.invoice_number}</td>
                    <td>${row.invoice_date}</td>
                    <td>${row.due_date}</td>
                    <td>${row.hsn_sac}</td>
                    <td>${row.description}</td>
                    <td>${row.invoice_value}</td>
                    <td>${row.place_of_supply}</td>
                    <td>${row.taxable_value}</td>
                    <td>${row.integrated_tax}</td>
                    <td>${row.central_tax}</td>
                    <td>${row.state_tax}</td>
                    <td>${row.cess}</td>
                    <td>${row.sub_total}</td>
                    <td>${row.tds}</td>
                    <td>${row.discount}</td>
                    <td>${row.total}</td>
                    <td>${row.receiving_status}</td>
                    <td>${row.amount_due}</td>
                `;
                tbody.appendChild(tr);
            });

            displayStats();
        }

        function displayStats() {
            const stats = document.getElementById('stats');

            const totalInvoices = processedData.length;

            let totalAmount = 0;
            let totalDue = 0;
            processedData.forEach(row => {
                const total = parseFloat(row.total);
                const due = parseFloat(row.amount_due);
                if (!isNaN(total)) totalAmount += total;
                if (!isNaN(due)) totalDue += due;
            });

            stats.innerHTML = `
                <div class="stat-card">
                    <h3>${totalInvoices}</h3>
                    <p>Total Invoices</p>
                </div>
                <div class="stat-card">
                    <h3>‚Çπ${totalAmount.toFixed(2)}</h3>
                    <p>Total Amount</p>
                </div>
                <div class="stat-card">
                    <h3>‚Çπ${totalDue.toFixed(2)}</h3>
                    <p>Total Amount Due</p>
                </div>
            `;
        }

        function downloadExcel() {
            const ws = XLSX.utils.json_to_sheet(processedData.map(row => ({
                'Months': row.months,
                'GSTIN of customer': row.gstin,
                'Customer Name': row.customer_name,
                'Invoice number': row.invoice_number,
                'Invoice date': row.invoice_date,
                'Due Date': row.due_date,
                'HSN/SAC': row.hsn_sac,
                'Description': row.description,
                'Invoice Value (Rs)': row.invoice_value,
                'Place of supply': row.place_of_supply,
                'Taxable Value (Rs)': row.taxable_value,
                'Integrated Tax (Rs)': row.integrated_tax,
                'Central Tax (Rs)': row.central_tax,
                'State/UT Tax (Rs)': row.state_tax,
                'Cess (Rs)': row.cess,
                'Sub Total': row.sub_total,
                'TDS': row.tds,
                'Discount': row.discount,
                'Total': row.total,
                'Receiving status': row.receiving_status,
                'Amount due': row.amount_due
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Invoice Data');
            XLSX.writeFile(wb, 'Processed_Invoice_Data.xlsx');
        }

        function downloadCSV() {
            const headers = ['Months', 'GSTIN of customer', 'Customer Name', 'Invoice number', 'Invoice date', 'Due Date', 'HSN/SAC', 'Description', 'Invoice Value (Rs)', 'Place of supply', 'Taxable Value (Rs)', 'Integrated Tax (Rs)', 'Central Tax (Rs)', 'State/UT Tax (Rs)', 'Cess (Rs)', 'Sub Total', 'TDS', 'Discount', 'Total', 'Receiving status', 'Amount due'];

            let csv = headers.join(',') + '\n';

            processedData.forEach(row => {
                const values = [
                    row.months, row.gstin, row.customer_name, row.invoice_number,
                    row.invoice_date, row.due_date, row.hsn_sac, row.description,
                    row.invoice_value, row.place_of_supply, row.taxable_value,
                    row.integrated_tax, row.central_tax, row.state_tax, row.cess,
                    row.sub_total, row.tds, row.discount, row.total,
                    row.receiving_status, row.amount_due
                ].map(v => `"${v}"`);

                csv += values.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Processed_Invoice_Data.csv';
            a.click();
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }
    </script>
</body>
</html>